<script src="https://checkout.culqi.com/js/v4"></script>

<h2>Checkout</h2>
<input type="text" id="nombre" placeholder="Nombre completo" />
<input type="email" id="correo" placeholder="Correo electrónico" />
<button onclick="pagarConCulqi()">Pagar</button>

<script>
  Culqi.publicKey = 'pk_test_9j3tnJnCznXfrk34';

  function pagarConCulqi() {
    const nombre = document.getElementById('nombre').value;
    const correo = document.getElementById('correo').value;

    const total = 1500; // en céntimos: 15.00 soles

    Culqi.options({
      title: 'Tienda Virtual',
      currency: 'PEN',
      description: 'Pago con Culqi',
      amount: total
    });

    Culqi.settings({
      lang: 'es',
      modal: true,
      installments: false
    });

    Culqi.open({
      amount: total,
      email: correo
    });
  }

  // Culqi devuelve un token
  function culqi() {
    if (Culqi.token) {
      const token = Culqi.token.id;

      const datosPago = {
        token,
        nombre: document.getElementById('nombre').value,
        correo: document.getElementById('correo').value,
        total: 1500 // céntimos
      };

      fetch('/api/culqi/pagar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datosPago)
      })
      .then(res => res.json())
      .then(data => {
        alert(data.msg || "Pago exitoso");
      })
      .catch(err => {
        console.error('Error:', err);
        alert("Error al procesar el pago");
      });

    } else {
      console.error(Culqi.error);
      alert(Culqi.error.user_message || "Error en el proceso de pago");
    }
  }
</script>
