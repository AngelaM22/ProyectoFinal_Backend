<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Tienda Saludable</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
    }
    #carrito-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      padding: 20px;
      transition: right 0.3s;
      overflow-y: auto;
      z-index: 1050;
    }
    #carrito-panel.visible {
      right: 0;
    }
  </style>
</head>
<body>
  <header class="bg-success text-white p-3 d-flex justify-content-between align-items-center">
    <h1 class="h4 mb-0">Ecommerce Saludable</h1>
    <div class="d-flex align-items-center gap-2">
      <input type="text" id="buscar" class="form-control form-control-sm" placeholder="Buscar...">
      <button class="btn btn-light btn-sm" onclick="buscar()">Buscar</button>
      <button class="btn btn-outline-light btn-sm" onclick="logout()">üö™ Salir</button>
      <div class="position-relative" onclick="toggleCarrito()" style="cursor:pointer">
        <i class="bi bi-cart fs-5"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-count">0</span>
      </div>
    </div>
  </header>

  <div class="d-flex">
    <aside class="bg-white p-3 border-end" style="width: 200px; min-height: 100vh;">
      <h5 class="text-success">Categor√≠as</h5>
      <ul id="lista-categorias" class="list-group list-group-flush"></ul>
    </aside>

    <main class="p-4 flex-grow-1">
      <div class="row" id="productos"></div>
    </main>
  </div>

  <div id="carrito-panel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5>üõí Tu Carrito</h5>
      <button class="btn-close" onclick="toggleCarrito()"></button>
    </div>
    <div id="carrito-contenido"></div>
    <div class="fw-bold mt-3" id="carrito-total"></div>
    <button class="btn btn-success w-100 mt-2" onclick="pagar()">Realizar Pedido</button>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];

    const renderCarrito = () => {
      const cont = document.getElementById('carrito-contenido');
      const totalDiv = document.getElementById('carrito-total');
      cont.innerHTML = '';
      let total = 0;

      carrito.forEach((item, i) => {
        total += item.precio * item.cantidad;
        cont.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>${item.nombre} x ${item.cantidad}</div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-success" onclick="sumar(${i})">+</button>
              <button class="btn btn-outline-secondary" onclick="restar(${i})">-</button>
              <button class="btn btn-outline-danger" onclick="eliminar(${i})">üóëÔ∏è</button>
            </div>
          </div>`;
      });

      totalDiv.innerText = `Total: S/ ${total.toFixed(2)}`;
      document.getElementById('cart-count').innerText = carrito.reduce((acc, el) => acc + el.cantidad, 0);
      localStorage.setItem('carrito', JSON.stringify(carrito));
    };

    const toggleCarrito = () => {
      document.getElementById('carrito-panel').classList.toggle('visible');
    };

    const sumar = i => { carrito[i].cantidad++; renderCarrito(); };
    const restar = i => { carrito[i].cantidad > 1 ? carrito[i].cantidad-- : carrito.splice(i, 1); renderCarrito(); };
    const eliminar = i => { carrito.splice(i, 1); renderCarrito(); };
    const pagar = () => {
      if (!carrito.length) return alert('Carrito vac√≠o');
      document.getElementById('carrito-contenido').innerHTML = '<div class="alert alert-success">‚úÖ Pedido realizado exitosamente.</div>';
      carrito.length = 0;
      renderCarrito();
    };

    const agregarAlCarrito = (id, nombre, precio) => {
      const existe = carrito.find(p => p.id === id);
      existe ? existe.cantidad++ : carrito.push({ id, nombre, precio, cantidad: 1 });
      renderCarrito();
    };

    const buscar = () => {
      const texto = document.getElementById('buscar').value.toLowerCase();
      document.querySelectorAll('.card').forEach(card => {
        const nombre = card.querySelector('h5').innerText.toLowerCase();
        card.style.display = nombre.includes(texto) ? 'block' : 'none';
      });
    };

    const cargarProductos = (categoria = null) => {
      let url = '/api/productos';
      if (categoria) url += `/categoria/${encodeURIComponent(categoria)}`;

      fetch(url, { headers: { Authorization: token } })
        .then(r => r.json())
        .then(data => {
          const grid = document.getElementById('productos');
          grid.innerHTML = '';
          if (data.length === 0) {
            grid.innerHTML = '<p class="text-muted">No hay productos en esta categor√≠a.</p>';
            return;
          }
          data.forEach(p => {
            grid.innerHTML += `
              <div class="col-md-3">
                <div class="card h-100">
                  <img src="${p.imagen}" class="card-img-top" alt="${p.nombre}" style="height:150px; object-fit:cover;">
                  <div class="card-body text-center">
                    <h5 class="card-title">${p.nombre}</h5>
                    <p class="card-text">S/ ${p.precio.toFixed(2)}</p>
                    <p class="text-muted small">${p.categoria}</p>
                    <button class="btn btn-success btn-sm" onclick="agregarAlCarrito('${p._id}', '${p.nombre}', ${p.precio})">Agregar</button>
                  </div>
                </div>
              </div>`;
          });
        });
    };

    const cargarCategorias = () => {
      fetch('/api/productos/categorias', { headers: { Authorization: token } })
        .then(r => r.json())
        .then(categorias => {
          const ul = document.getElementById('lista-categorias');
          ul.innerHTML = `<li class="list-group-item list-group-item-action" onclick="cargarProductos()">üîÅ Ver todos</li>`;
          categorias.forEach(c => {
            ul.innerHTML += `<li class="list-group-item list-group-item-action" onclick="cargarProductos('${c}')">${c}</li>`;
          });
        });
    };

    const logout = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('carrito');
      window.location.href = 'login.html';
    };

    cargarProductos();
    cargarCategorias();
    renderCarrito();
  </script>
</body>
</html>
